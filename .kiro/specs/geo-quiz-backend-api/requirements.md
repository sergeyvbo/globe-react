# Requirements Document

## Introduction

Данная спецификация описывает требования к backend API для географической викторины. Backend должен обеспечивать аутентификацию пользователей, хранение профилей, игровой статистики и функциональность списка лидеров. API будет построен на ASP.NET Core с использованием SQLite в качестве базы данных и будет интегрироваться с существующим React фронтендом.

## Requirements

### Requirement 1

**User Story:** Как пользователь, я хочу зарегистрироваться и войти в систему, чтобы сохранять свой прогресс в игре

#### Acceptance Criteria

1. WHEN пользователь отправляет POST запрос на `/api/auth/register` с email и password THEN система SHALL создать новый аккаунт и вернуть JWT токены
2. WHEN пользователь отправляет POST запрос на `/api/auth/login` с валидными credentials THEN система SHALL вернуть access и refresh токены
3. WHEN пользователь отправляет невалидные данные для регистрации THEN система SHALL вернуть ошибку валидации с кодом 422
4. WHEN пользователь пытается зарегистрироваться с уже существующим email THEN система SHALL вернуть ошибку с кодом 409
5. WHEN пользователь отправляет неверные credentials для входа THEN система SHALL вернуть ошибку с кодом 401

### Requirement 2

**User Story:** Как аутентифицированный пользователь, я хочу управлять своим профилем, чтобы персонализировать свой опыт

#### Acceptance Criteria

1. WHEN аутентифицированный пользователь отправляет GET запрос на `/api/auth/me` THEN система SHALL вернуть информацию о текущем пользователе
2. WHEN аутентифицированный пользователь отправляет PUT запрос на `/api/auth/profile` с обновленными данными THEN система SHALL обновить профиль пользователя
3. WHEN пользователь отправляет PUT запрос на `/api/auth/change-password` с текущим и новым паролем THEN система SHALL обновить пароль
4. WHEN неаутентифицированный пользователь пытается получить доступ к защищенным endpoints THEN система SHALL вернуть ошибку 401

### Requirement 3

**User Story:** Как пользователь, я хочу автоматически обновлять токены доступа, чтобы не прерывать игровую сессию

#### Acceptance Criteria

1. WHEN пользователь отправляет POST запрос на `/api/auth/refresh` с валидным refresh токеном THEN система SHALL вернуть новые access и refresh токены
2. WHEN пользователь отправляет истекший или невалидный refresh токен THEN система SHALL вернуть ошибку 401
3. WHEN пользователь отправляет POST запрос на `/api/auth/logout` THEN система SHALL инвалидировать refresh токен

### Requirement 4

**User Story:** Как игрок, я хочу сохранять статистику своих игр, чтобы отслеживать свой прогресс

#### Acceptance Criteria

1. WHEN аутентифицированный пользователь отправляет POST запрос на `/api/game-stats` с данными игровой сессии THEN система SHALL сохранить статистику игры
2. WHEN пользователь отправляет GET запрос на `/api/game-stats/me` THEN система SHALL вернуть агрегированную статистику пользователя
3. WHEN пользователь отправляет GET запрос на `/api/game-stats/me/history` THEN система SHALL вернуть историю игровых сессий
4. IF игровая сессия содержит некорректные данные THEN система SHALL вернуть ошибку валидации 422

### Requirement 5

**User Story:** Как игрок, я хочу видеть список лидеров, чтобы сравнивать свои результаты с другими игроками

#### Acceptance Criteria

1. WHEN пользователь отправляет GET запрос на `/api/leaderboard` THEN система SHALL вернуть топ игроков по общему счету
2. WHEN пользователь отправляет GET запрос на `/api/leaderboard?gameType=countries` THEN система SHALL вернуть лидеров для конкретного типа игры
3. WHEN пользователь отправляет GET запрос на `/api/leaderboard?period=week` THEN система SHALL вернуть лидеров за указанный период
4. WHEN пользователь запрашивает список лидеров THEN система SHALL вернуть данные в формате, совместимом с фронтенд компонентами

### Requirement 6

**User Story:** Как разработчик, я хочу иметь надежную систему хранения данных, чтобы обеспечить целостность пользовательских данных

#### Acceptance Criteria

1. WHEN система запускается впервые THEN она SHALL автоматически создать и настроить SQLite базу данных
2. WHEN происходит ошибка базы данных THEN система SHALL логировать ошибку и вернуть соответствующий HTTP статус код
3. WHEN выполняются операции с базой данных THEN система SHALL использовать транзакции для обеспечения целостности данных
4. WHEN система обрабатывает пароли THEN она SHALL использовать безопасное хеширование с солью

### Requirement 7

**User Story:** Как администратор системы, я хочу иметь логирование и мониторинг API, чтобы отслеживать работу системы

#### Acceptance Criteria

1. WHEN происходят HTTP запросы THEN система SHALL логировать основную информацию о запросах и ответах
2. WHEN происходят ошибки THEN система SHALL логировать детальную информацию об ошибках
3. WHEN система запускается THEN она SHALL логировать информацию о конфигурации и состоянии подключений
4. WHEN происходят операции аутентификации THEN система SHALL логировать попытки входа (без паролей)

### Requirement 8

**User Story:** Как игрок, я хочу иметь возможность играть анонимно, чтобы попробовать игру без регистрации

#### Acceptance Criteria

1. WHEN анонимный пользователь играет в игру THEN его результаты SHALL храниться только на клиенте в localStorage
2. WHEN анонимный пользователь просматривает список лидеров THEN фронтенд SHALL объединить серверные данные с локальными анонимными результатами
3. WHEN анонимные результаты отображаются в списке лидеров THEN они SHALL показываться как "You (Guest)" или аналогичное обозначение
4. WHEN анонимный пользователь регистрируется или входит в систему THEN фронтенд SHALL предложить перенести локальные результаты на сервер

### Requirement 9

**User Story:** Как фронтенд разработчик, я хочу иметь CORS поддержку, чтобы React приложение могло взаимодействовать с API

#### Acceptance Criteria

1. WHEN фронтенд отправляет preflight OPTIONS запрос THEN API SHALL вернуть соответствующие CORS заголовки
2. WHEN API возвращает ответы THEN они SHALL содержать необходимые CORS заголовки для React приложения
3. WHEN настраивается CORS THEN система SHALL разрешать запросы только с доверенных доменов в production
4. WHEN система работает в development режиме THEN CORS SHALL разрешать запросы с localhost